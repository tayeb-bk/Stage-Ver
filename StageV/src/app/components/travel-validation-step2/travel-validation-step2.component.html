<!-- HTML Template pour Travel Validation -->
<div class="travel-validation-container">
  <div class="header">
    <h2>Validation des Voyages - √âtape 2 (Finale)</h2>

    <!-- Statistiques -->
    <div class="stats">
      <span class="stat-item">
        <strong>{{ getFilteredCount() }}</strong> sur <strong>{{ getTotalCount() }}</strong> voyages
      </span>
    </div>
  </div>

  <!-- Section des filtres -->
  <div class="filters-container">
    <div class="filters-header">
      <h3>Filtres de recherche</h3>
      <div class="filter-actions">
        <button
          class="btn-toggle-filters"
          (click)="toggleAdvancedFilters()">
          {{ showAdvancedFilters ? 'Masquer' : 'Afficher' }} les filtres avanc√©s
        </button>
        <button class="btn-clear-filters" (click)="clearFilters()">
          Effacer les filtres
        </button>
      </div>
    </div>

    <!-- Filtres de base -->
    <div class="basic-filters">
      <div class="filter-group">
        <label for="statusFilter">Statut:</label>
        <select
          id="statusFilter"
          [(ngModel)]="filters.status"
          (change)="applyFilters()"
          class="filter-select">
          <option value="">Tous les statuts</option>
          <option value="STEP1_APPROVED">Pr√™t pour validation finale</option>
          <option value="APPROVED">Approuv√© d√©finitivement</option>
          <option value="REJECTED">Rejet√© d√©finitivement</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="objective">Objectif:</label>
        <input
          type="text"
          id="objective"
          [(ngModel)]="filters.objective"
          (input)="applyFilters()"
          placeholder="Rechercher par objectif..."
          class="filter-input">
      </div>

      <div class="filter-group">
        <label for="destination">Destination:</label>
        <select
          id="destination"
          [(ngModel)]="filters.destination"
          (change)="applyFilters()"
          class="filter-select">
          <option value="">Toutes les destinations</option>
          <option *ngFor="let dest of uniqueDestinations" [value]="dest">
            {{ dest }}
          </option>
        </select>
      </div>
    </div>

    <!-- Filtres avanc√©s -->
    <div class="advanced-filters" [class.visible]="showAdvancedFilters">
      <div class="filter-row">
        <div class="filter-group">
          <label for="dateFrom">Date de d√©part (du):</label>
          <input
            type="date"
            id="dateFrom"
            [(ngModel)]="filters.dateFrom"
            (change)="applyFilters()"
            class="filter-input">
        </div>

        <div class="filter-group">
          <label for="dateTo">Date de retour (au):</label>
          <input
            type="date"
            id="dateTo"
            [(ngModel)]="filters.dateTo"
            (change)="applyFilters()"
            class="filter-input">
        </div>
      </div>
    </div>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="error" class="error-message">
    <i class="error-icon">‚ö†Ô∏è</i>
    {{ error }}
  </div>

  <!-- Loading spinner -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement...</p>
  </div>

  <!-- Liste des voyages -->
  <div *ngIf="!loading" class="travel-list">
    <div *ngIf="travels.length === 0" class="no-data">
      <i class="no-data-icon">‚úàÔ∏è</i>
      <p>Aucun voyage trouv√© avec les filtres actuels</p>
      <p class="no-data-suggestion">
        Essayez de modifier vos crit√®res de recherche ou
        <button class="link-button" (click)="clearFilters()">effacez tous les filtres</button>
      </p>
    </div>

    <div *ngFor="let travel of travels" class="travel-card" [class]="getPriorityClass(travel)">
      <div class="travel-header">
        <div class="travel-info">
          <div class="travel-id">
            <strong>Voyage #{{ travel.id }}</strong>
          </div>
          <div class="travel-priority" *ngIf="getPriorityText(travel)">
            {{ getPriorityText(travel) }}
          </div>
        </div>
        <div class="travel-status {{ getStatusClass(travel.status) }}">
          {{ getStatusText(travel.status) }}
        </div>
      </div>

      <div class="travel-summary">
        <div class="summary-item">
          <label>Objectif:</label>
          <span>{{ travel.objective || 'Non sp√©cifi√©' }}</span>
        </div>
        <div class="summary-item">
          <label>Destination:</label>
          <span>{{ travel.destination || 'Non sp√©cifi√©e' }}</span>
        </div>
        <div class="summary-item">
          <label>D√©part:</label>
          <span>{{ travel.departureDate | date }}</span>
        </div>
        <div class="summary-item">
          <label>Retour:</label>
          <span>{{ travel.returnDate | date }}</span>
        </div>
      </div>

      <!-- Actions de validation Step 2 -->
      <div class="validation-actions" *ngIf="travel.status === 'STEP1_APPROVED'">
        <div class="step2-header">
          <h4>üéØ Validation Finale - √âtape 2</h4>
          <p class="validation-info">
            Ce voyage a pass√© la premi√®re validation. Effectuez maintenant la validation finale pour approuver ou rejeter d√©finitivement cette demande de voyage.
          </p>
        </div>

        <div class="action-buttons">
          <button
            class="btn btn-review"
            (click)="openReviewModal(travel)">
            <i class="btn-icon">üëÅÔ∏è</i>
            Examiner en d√©tail
          </button>
          <button
            class="btn btn-approve-final"
            (click)="validateStep2(travel.id, true)"
            [disabled]="!canValidateStep2() || loading">
            <i class="btn-icon">‚úÖ</i>
            Approuver D√©finitivement
          </button>
          <button
            class="btn btn-reject-final"
            (click)="validateStep2(travel.id, false)"
            [disabled]="!canValidateStep2() || loading">
            <i class="btn-icon">‚ùå</i>
            Rejeter D√©finitivement
          </button>
        </div>
      </div>

      <!-- Message pour les voyages d√©j√† valid√©s -->
      <div class="validation-completed" *ngIf="travel.status !== 'STEP1_APPROVED'">
        <i class="completed-icon">
          {{ travel.status === 'APPROVED' ? '‚úÖ' : travel.status === 'REJECTED' ? '‚ùå' : 'üîÑ' }}
        </i>
        <span>
          <ng-container *ngIf="travel.status === 'APPROVED'">
            ‚ú® Voyage approuv√© d√©finitivement - Processus termin√©
          </ng-container>
          <ng-container *ngIf="travel.status === 'REJECTED'">
            ‚ùå Voyage rejet√© d√©finitivement
          </ng-container>
        </span>
      </div>
    </div>
  </div>

  <!-- Modal de revue d√©taill√©e -->
  <div class="modal-overlay" *ngIf="selectedTravelForReview" (click)="closeReviewModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Examen D√©taill√© - Voyage #{{ selectedTravelForReview.id }}</h3>
        <button class="btn-close" (click)="closeReviewModal()">‚úï</button>
      </div>

      <div class="modal-body">
        <div class="detail-section">
          <h4>‚úàÔ∏è Informations de Voyage</h4>
          <div class="detail-grid">
            <div class="detail-item">
              <label>Objectif du voyage:</label>
              <span>{{ selectedTravelForReview.objective || 'Non sp√©cifi√©' }}</span>
            </div>
            <div class="detail-item">
              <label>Destination:</label>
              <span>{{ selectedTravelForReview.destination || 'Non sp√©cifi√©e' }}</span>
            </div>
            <div class="detail-item">
              <label>Date de d√©part:</label>
              <span>{{ selectedTravelForReview.departureDate | date }}</span>
            </div>
            <div class="detail-item">
              <label>Date de retour:</label>
              <span>{{ selectedTravelForReview.returnDate | date }}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>üìä Statut de Validation</h4>
          <div class="status-timeline">
            <div class="timeline-item completed">
              <div class="timeline-marker">‚úÖ</div>
              <div class="timeline-content">
                <strong>√âtape 1 - Validation initiale</strong>
                <span>Approuv√©e</span>
              </div>
            </div>
            <div class="timeline-item current">
              <div class="timeline-marker">üîÑ</div>
              <div class="timeline-content">
                <strong>√âtape 2 - Validation finale</strong>
                <span>En cours de traitement</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" (click)="closeReviewModal()">
          Fermer
        </button>
        <button
          class="btn btn-approve-final"
          (click)="validateStep2(selectedTravelForReview.id, true)"
          [disabled]="loading || !canValidateStep2()">
          <i class="btn-icon">‚úÖ</i>
          Approuver D√©finitivement
        </button>
        <button
          class="btn btn-reject-final"
          (click)="validateStep2(selectedTravelForReview.id, false)"
          [disabled]="loading || !canValidateStep2()">
          <i class="btn-icon">‚ùå</i>
          Rejeter D√©finitivement
        </button>
      </div>
    </div>
  </div>
</div>

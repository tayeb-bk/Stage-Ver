<div class="visa-validation-container">
  <div class="header">
    <h2>Validation des Demandes de Visa - √âtape 1</h2>

    <!-- Statistiques -->
    <div class="stats">
      <span class="stat-item">
        <strong>{{ getFilteredCount() }}</strong> sur <strong>{{ getTotalCount() }}</strong> demandes
      </span>
    </div>
  </div>

  <!-- Section des filtres -->
  <div class="filters-container">
    <div class="filters-header">
      <h3>Filtres de recherche</h3>
      <div class="filter-actions">
        <button
          class="btn-toggle-filters"
          (click)="toggleAdvancedFilters()">
          {{ showAdvancedFilters ? 'Masquer' : 'Afficher' }} les filtres avanc√©s
        </button>
        <button class="btn-clear-filters" (click)="clearFilters()">
          Effacer les filtres
        </button>
      </div>
    </div>

    <!-- Filtres de base -->
    <div class="basic-filters">
      <div class="filter-group">
        <label for="statusFilter">Statut:</label>
        <select
          id="statusFilter"
          [(ngModel)]="filters.status"
          (change)="onFilterChange()"
          class="filter-select">
          <option value="">Tous les statuts</option>
          <option value="PENDING">En attente</option>
          <option value="STEP1_APPROVED">√âtape 1 approuv√©e</option>
          <option value="STEP1_REJECTED">√âtape 1 rejet√©e</option>
          <option value="APPROVED">Approuv√©e</option>
          <option value="REJECTED">Rejet√©e</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="missionPurpose">Objectif de mission:</label>
        <input
          type="text"
          id="missionPurpose"
          [(ngModel)]="filters.missionPurpose"
          (input)="onFilterChange()"
          placeholder="Rechercher par objectif..."
          class="filter-input">
      </div>

      <div class="filter-group">
        <label for="countryFirstMission">Pays de premi√®re mission:</label>
        <select
          id="countryFirstMission"
          [(ngModel)]="filters.countryOfFirstMission"
          (change)="onFilterChange()"
          class="filter-select">
          <option value="">Tous les pays</option>
          <option *ngFor="let country of uniqueCountriesFirstMission" [value]="country">
            {{ country }}
          </option>
        </select>
      </div>
    </div>

    <!-- Filtres avanc√©s -->
    <div class="advanced-filters" [class.visible]="showAdvancedFilters">
      <div class="filter-row">
        <div class="filter-group">
          <label for="countryIssuingVisa">Pays √©metteur du visa:</label>
          <select
            id="countryIssuingVisa"
            [(ngModel)]="filters.countryIssuingVisa"
            (change)="onFilterChange()"
            class="filter-select">
            <option value="">Tous les pays</option>
            <option *ngFor="let country of uniqueCountriesIssuingVisa" [value]="country">
              {{ country }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label for="travelerType">Type de voyageur:</label>
          <select
            id="travelerType"
            [(ngModel)]="filters.travelerType"
            (change)="onFilterChange()"
            class="filter-select">
            <option value="">Tous les types</option>
            <option *ngFor="let type of uniqueTravelerTypes" [value]="type">
              {{ type }}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-row">
        <div class="filter-group">
          <label for="passportNumber">Num√©ro de passeport:</label>
          <input
            type="text"
            id="passportNumber"
            [(ngModel)]="filters.passportNumber"
            (input)="onFilterChange()"
            placeholder="Rechercher par num√©ro..."
            class="filter-input">
        </div>

        <div class="filter-group">
          <label for="issuingCountry">Pays d'√©mission du passeport:</label>
          <select
            id="issuingCountry"
            [(ngModel)]="filters.issuingCountry"
            (change)="onFilterChange()"
            class="filter-select">
            <option value="">Tous les pays</option>
            <option *ngFor="let country of uniqueIssuingCountries" [value]="country">
              {{ country }}
            </option>
          </select>
        </div>
      </div>

      <div class="filter-row">
        <div class="filter-group">
          <label for="dateFrom">Date de mission (du):</label>
          <input
            type="date"
            id="dateFrom"
            [(ngModel)]="filters.dateFrom"
            (change)="onFilterChange()"
            class="filter-input">
        </div>

        <div class="filter-group">
          <label for="dateTo">Date de mission (au):</label>
          <input
            type="date"
            id="dateTo"
            [(ngModel)]="filters.dateTo"
            (change)="onFilterChange()"
            class="filter-input">
        </div>
      </div>
    </div>
  </div>

  <!-- Message d'erreur -->
  <div *ngIf="error" class="error-message">
    <i class="error-icon">‚ö†Ô∏è</i>
    {{ error }}
  </div>

  <!-- Loading spinner -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement...</p>
  </div>

  <!-- Liste des demandes de visa -->
  <div *ngIf="!loading" class="visa-list">
    <div *ngIf="visaRequests.length === 0" class="no-data">
      <i class="no-data-icon">üìÑ</i>
      <p>Aucune demande de visa trouv√©e avec les filtres actuels</p>
      <p class="no-data-suggestion">
        Essayez de modifier vos crit√®res de recherche ou
        <button class="link-button" (click)="clearFilters()">effacez tous les filtres</button>
      </p>
    </div>

    <div *ngFor="let visa of visaRequests" class="visa-card">
      <div class="visa-header">
        <div class="visa-id">
          <strong>Demande #{{ visa.id }}</strong>
        </div>
        <div class="visa-status {{ getStatusClass(visa.status) }}">
          {{ getStatusText(visa.status) }}
        </div>
      </div>

      <div class="visa-details">
        <div class="detail-row">
          <div class="detail-group">
            <label>Objet du d√©placement:</label>
            <span>{{ visa.missionPurpose || 'Non sp√©cifi√©' }}</span>
          </div>
          <div class="detail-group">
            <label>Type de voyageur:</label>
            <span>{{ visa.travelerType || 'Non sp√©cifi√©' }}</span>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-group">
            <label>Date de mission:</label>
            <span>{{ formatDate(visa.dateOfMission) }}</span>
          </div>
          <div class="detail-group">
            <label>Pays de premi√®re mission:</label>
            <span>{{ visa.countryOfFirstMission || 'Non sp√©cifi√©' }}</span>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-group">
            <label>Pays √©metteur du visa:</label>
            <span>{{ visa.countryIssuingVisa || 'Non sp√©cifi√©' }}</span>
          </div>
          <div class="detail-group">
            <label>Num√©ro de passeport:</label>
            <span>{{ visa.passportNumber || 'Non sp√©cifi√©' }}</span>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-group">
            <label>Date d'√©mission:</label>
            <span>{{ formatDate(visa.issueDate) }}</span>
          </div>
          <div class="detail-group">
            <label>Date d'expiration:</label>
            <span>{{ formatDate(visa.expiryDate) }}</span>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-group">
            <label>Pays d'√©mission:</label>
            <span>{{ visa.issuingCountry || 'Non sp√©cifi√©' }}</span>
          </div>
          <div class="detail-group">
            <label>√âmis par:</label>
            <span>{{ visa.issuedBy || 'Non sp√©cifi√©' }}</span>
          </div>
        </div>
      </div>

      <!-- Actions de validation Step 1 -->
      <div class="validation-actions" *ngIf="visa.status === 'PENDING'">
        <h4>Validation √âtape 1</h4>
        <p class="validation-info">
          Premi√®re validation de la demande de visa. V√©rifiez les informations et approuvez ou rejetez cette demande.
        </p>
        <div class="action-buttons">
          <button
            class="btn btn-approve"
            (click)="validateStep1(visa.id, true)"
            [disabled]="loading || !canValidate()">
            <i class="btn-icon">‚úì</i>
            Approuver √âtape 1
          </button>
          <button
            class="btn btn-reject"
            (click)="validateStep1(visa.id, false)"
            [disabled]="loading || !canValidate()">
            <i class="btn-icon">‚úó</i>
            Rejeter √âtape 1
          </button>
        </div>
      </div>

      <!-- Message pour les demandes d√©j√† valid√©es -->
      <div class="validation-completed" *ngIf="visa.status !== 'PENDING'">
        <i class="completed-icon">
          {{ visa.status === 'STEP1_APPROVED' ? '‚úÖ' : visa.status === 'STEP1_REJECTED' ? '‚ùå' : 'üîÑ' }}
        </i>
        <span>
          <ng-container *ngIf="visa.status === 'STEP1_APPROVED'">
            √âtape 1 approuv√©e - En attente de l'√©tape 2
          </ng-container>
          <ng-container *ngIf="visa.status === 'STEP1_REJECTED'">
            √âtape 1 rejet√©e
          </ng-container>
          <ng-container *ngIf="visa.status === 'APPROVED'">
            Demande compl√®tement approuv√©e
          </ng-container>
          <ng-container *ngIf="visa.status === 'REJECTED'">
            Demande rejet√©e d√©finitivement
          </ng-container>
        </span>
      </div>
    </div>
  </div>
</div>

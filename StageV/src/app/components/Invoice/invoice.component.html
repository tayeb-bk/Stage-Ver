<div class="invoice-container">
  <h2>ğŸ“‘ Gestion des Factures</h2>

  <!-- Messages -->
  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert alert-error">{{ errorMessage }}</div>

  <!-- Formulaire -->
  <div class="form-section">
    <h3>â• Nouvelle facture</h3>
    <form (ngSubmit)="generateInvoice()">
      <!-- SÃ©lection du voyage -->
      <label for="travelSelect">Voyage approuvÃ©:</label>
      <select id="travelSelect" [(ngModel)]="selectedTravelId" name="travelId" required>
        <option *ngFor="let t of approvedTravels" [value]="t.id">
          Voyage #{{ t.id }} - {{ t.destination }}
          ({{ t.departureDate | date:'dd/MM/yyyy' }} â†’ {{ t.returnDate | date:'dd/MM/yyyy' }})
          - CrÃ©Ã© par {{ t.requester?.firstName }} {{ t.requester?.lastName }}
        </option>
      </select>

      <!-- Champs du billet -->
      <label>NumÃ©ro billet:</label>
      <input type="text" [(ngModel)]="newInvoice.ticketNumber" name="ticketNumber">

      <label>Montant billet (DT):</label>
      <input type="number" [(ngModel)]="newInvoice.ticketAmount" name="ticketAmount">

      <!-- Champs de l'hÃ´tel -->
      <label>Nom hÃ´tel:</label>
      <input type="text" [(ngModel)]="newInvoice.hotelName" name="hotelName">

      <label>Prix par nuitÃ©e (DT):</label>
      <input type="number" [(ngModel)]="newInvoice.pricePerNight" name="pricePerNight">

      <!-- Champs du Per diem -->
      <label>Per Diem (DT/jour):</label>
      <input type="number" [(ngModel)]="newInvoice.perDiemRate" name="perDiemRate">

      <button type="submit" class="btn btn-success" [disabled]="!canValidate()">
        âœ… GÃ©nÃ©rer Facture
      </button>    </form>
  </div>

  <!-- Liste -->
  <h3>ğŸ“‹ Liste des factures</h3>
  <table class="invoice-table">
    <thead>
    <tr>
      <th>#</th>
      <th>Voyage</th>
      <th>CrÃ©ateur</th>
      <th>Billet</th>
      <th>HÃ´tel</th>
      <th>Per Diem</th>
      <th>Total</th>
      <th>Actions</th>
    </tr>
    </thead>
    <tbody>
    <!-- Boucle des factures -->
    <tr *ngFor="let inv of invoices; let i = index">
      <td>{{ i + 1 }}</td>
      <td>
        {{ inv.travelRequest?.destination }}<br>
        <small>
          {{ inv.travelRequest?.departureDate | date:'dd/MM/yyyy' }} â†’ {{ inv.travelRequest?.returnDate | date:'dd/MM/yyyy' }}
        </small>
      </td>
      <td>
        {{ inv.travelRequest?.requester?.firstName }} {{ inv.travelRequest?.requester?.lastName }} <br>
        <small>{{ '@' + (inv.travelRequest?.requester?.username || 'inconnu') }}</small>
      </td>
      <td>{{ inv.ticketAmount || 0 }} DT <br><small>#{{ inv.ticketNumber }}</small></td>
      <td>{{ inv.hotelTotal || 0 }} DT <br><small>{{ inv.nights }} nuits</small></td>
      <td>{{ inv.perDiemTotal || 0 }} DT <br><small>{{ inv.travelDays }} jours</small></td>
      <td><b>{{ inv.totalAmount || 0 }} DT</b></td>
      <td>
        <button class="btn btn-download"
                (click)="downloadInvoiceFront(inv)"
                [disabled]="!canValidate()">
          â¬‡ï¸ TÃ©lÃ©charger
        </button>

        <button class="btn btn-delete"
                (click)="deleteInvoice(inv.id!)"
                [disabled]="!canValidate()">
          ğŸ—‘ï¸ Supprimer
        </button>
      </td>
    </tr>

    <!-- Aucun rÃ©sultat -->
    <tr *ngIf="invoices.length === 0">
      <td colspan="8" class="no-data">Aucune facture gÃ©nÃ©rÃ©e</td>
    </tr>
    </tbody>

  </table>
</div>
